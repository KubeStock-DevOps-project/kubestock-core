# GitOps CI/CD Pipeline Guide

## Overview

The CI/CD pipeline uses GitOps principles with ArgoCD. It consists of 6 stages split across two workflows:

- **Staging Pipeline** (`ci-cd-staging.yml`): Stages 1-4, triggered automatically on push to `main`/`develop`
- **Production Pipeline** (`ci-cd-production.yml`): Stages 5-6, triggered manually with approval

```
Staging (Auto):     [Stage 1] → [Stage 2] → [Stage 3] → [Stage 4] → ArgoCD Sync
Production (Manual): ────────────────────────────────────[Stage 5] → [Stage 6]
```

---

## Stage 1: Monitor & Trigger

**File:** `ci-cd-staging.yml`  
**Trigger:** Push to `main` or `develop`, or Pull Request

### What Happens:
1. Checks out the repository
2. Compares current commit with previous to detect which services changed
3. Outputs flags for each service indicating if it was modified

### Change Detection:
```bash
# Compares file paths to determine affected services
git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep 'backend/services/<service>'
```

### Outputs:
- `user_service_changed`
- `product_service_changed`
- `inventory_service_changed`
- `order_service_changed`
- `supplier_service_changed`
- `frontend_changed`

---

## Stage 2: Build & Containerize

**Depends on:** Stage 1  
**Runs:** In parallel for all 6 services

### What Happens:
1. Logs into GitHub Container Registry (GHCR)
2. Builds Docker image for each service using its Dockerfile
3. Pushes images to GHCR with multiple tags

### Services Built:
| Service | Context Path | Dockerfile |
|---------|--------------|------------|
| user-service | `./backend/services/user-service` | `Dockerfile` |
| product-catalog-service | `./backend/services/product-catalog-service` | `Dockerfile` |
| inventory-service | `./backend/services/inventory-service` | `Dockerfile` |
| order-service | `./backend/services/order-service` | `Dockerfile` |
| supplier-service | `./backend/services/supplier-service` | `Dockerfile` |
| frontend | `./frontend` | `Dockerfile` |

### Image Tags Applied:
- `sha-<commit-hash>` - Immutable, tied to specific commit
- `staging-latest` - Latest staging build (main branch only)
- Branch name tag

### Image Location:
```
ghcr.io/<owner>/inventory-system/<service-name>:sha-<commit>
```

---

## Stage 3: Security Scan

**Depends on:** Stage 2  
**Runs:** In parallel for all 6 services

### What Happens:
1. Pulls the built image from GHCR
2. Runs Trivy vulnerability scanner
3. Reports findings in table format (console output)
4. Generates SARIF report for GitHub Security tab

### Trivy Configuration:
- **Severity levels:** CRITICAL, HIGH, MEDIUM
- **Output formats:** Table (console), SARIF (GitHub Security)
- **Behavior:** Continues on error (non-blocking)

### Results:
- View in GitHub Actions logs (table format)
- View in repository Security tab (SARIF upload)

---

## Stage 4: GitOps Update

**Depends on:** Stage 3  
**Condition:** Only runs on `main` or `develop` branches

### What Happens:
1. Checks out repository with write permissions
2. Updates image tags in Kubernetes deployment manifests
3. Commits changes to Git
4. Pushes to repository
5. ArgoCD detects changes and syncs automatically

### Manifest Updates:
```bash
# Updates each service's deployment.yaml
sed -i "s|image: ghcr.io/.*/<service>:.*|image: ghcr.io/<owner>/<service>:sha-${NEW_TAG}|g" \
  k8s/base/services/<service>/deployment.yaml
```

### Files Modified:
```
k8s/base/services/
├── user-service/deployment.yaml
├── product-catalog-service/deployment.yaml
├── inventory-service/deployment.yaml
├── order-service/deployment.yaml
└── supplier-service/deployment.yaml
```

### Commit Message Format:
```
chore(deploy): update image tags to sha-<commit>

Auto-generated by CI/CD pipeline

Updated services:
- user-service
- product-catalog-service
- inventory-service
- order-service
- supplier-service

Commit: <sha>
Branch: <branch>
Triggered by: <actor>
```

### After Push:
- ArgoCD polls the Git repository (every 3 minutes)
- Detects manifest changes
- Auto-syncs staging environment (if auto-sync enabled)

---

## Stage 5: Manual Approval

**File:** `ci-cd-production.yml`  
**Trigger:** Manual `workflow_dispatch`

### Inputs Required:
| Input | Description | Required |
|-------|-------------|----------|
| `sha` | Git commit SHA to deploy | Yes |
| `deployment_strategy` | `canary`, `blue-green`, or `rolling` | Yes (default: canary) |

### What Happens:
1. Workflow pauses at `production-approval` environment
2. Designated reviewers receive notification
3. Reviewer approves or rejects in GitHub UI
4. On approval, proceeds to Stage 6

### GitHub Environment Setup:
- Create environment named `production-approval`
- Add required reviewers
- Enable "Required reviewers" protection rule

---

## Stage 6: Production Deployment

**Depends on:** Stage 5 (approval)  
**Runs:** One of three strategies based on input

### Canary Deployment (default)
Progressive traffic shifting:

```
Phase 1: Deploy canary pods (10% traffic)
         ↓ Monitor metrics (error rate, latency)
Phase 2: Increase to 50% traffic
         ↓ Monitor metrics
Phase 3: Promote to 100% traffic
         ↓ Remove canary pods
```

**Rollback trigger:** High error rate or latency spike

### Blue-Green Deployment
Zero-downtime switchover:

```
1. Deploy to "green" environment (inactive)
2. Run smoke tests on green
3. Switch load balancer from blue → green
4. Keep blue as backup (1 hour)
5. Cleanup blue after verification
```

**Rollback:** Switch load balancer back to blue

### Rolling Deployment
Service-by-service update:

```
For each service:
  1. Update deployment image
  2. Wait for rollout to complete
  3. Verify health
  4. Move to next service
```

**Rollback:** `kubectl rollout undo deployment/<service>`

---

## Pipeline Flow Summary

```
┌──────────────────────────────────────────────────────────────────┐
│                    STAGING WORKFLOW                               │
│                    (ci-cd-staging.yml)                           │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│   Push to main/develop                                           │
│         │                                                        │
│         ▼                                                        │
│   ┌─────────────┐                                                │
│   │  Stage 1    │  Detect changed services                       │
│   │  Trigger    │  Output: which services to build               │
│   └──────┬──────┘                                                │
│          │                                                       │
│          ▼                                                        │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│   │  Build      │  │  Build      │  │  Build      │  ... (x6)   │
│   │  user-svc   │  │  product    │  │  inventory  │             │
│   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘             │
│          │                │                │                     │
│          └────────────────┼────────────────┘                     │
│                           ▼                                       │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│   │  Trivy      │  │  Trivy      │  │  Trivy      │  ... (x6)   │
│   │  Scan       │  │  Scan       │  │  Scan       │             │
│   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘             │
│          │                │                │                     │
│          └────────────────┼────────────────┘                     │
│                           ▼                                       │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  Stage 4: GitOps Update                                  │   │
│   │  - Update k8s/base/services/*/deployment.yaml           │   │
│   │  - Commit and push to Git                                │   │
│   └──────────────────────────┬──────────────────────────────┘   │
│                              │                                   │
└──────────────────────────────┼───────────────────────────────────┘
                               ▼
                    ┌─────────────────────┐
                    │  ArgoCD detects     │
                    │  manifest changes   │
                    │  → Auto-sync        │
                    └─────────────────────┘

┌──────────────────────────────────────────────────────────────────┐
│                   PRODUCTION WORKFLOW                             │
│                   (ci-cd-production.yml)                         │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│   Manual trigger (workflow_dispatch)                             │
│   Input: sha, deployment_strategy                                │
│         │                                                        │
│         ▼                                                        │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  Stage 5: Manual Approval                                │   │
│   │  - Waits for reviewer approval                           │   │
│   │  - Environment: production-approval                      │   │
│   └──────────────────────────┬──────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  Stage 6: Deploy to Production                          │   │
│   │  - Canary: 10% → 50% → 100%                             │   │
│   │  - Blue-Green: Deploy green → Switch                     │   │
│   │  - Rolling: Service-by-service                           │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Triggering Deployments

### Staging (Automatic)
```bash
git push origin main
```

### Production (Manual)
```bash
# Via GitHub CLI
gh workflow run ci-cd-production.yml \
  -f sha=abc123def456 \
  -f deployment_strategy=canary

# Via GitHub UI
# Actions → ci-cd-production.yml → Run workflow → Fill inputs
```

---

## Monitoring

```bash
# ArgoCD status
kubectl get applications -n argocd

# Pod status
kubectl get pods -n inventory-system

# Rollout status
kubectl rollout status deployment/<service> -n inventory-system
```
