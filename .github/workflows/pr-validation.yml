name: Pull Request Validation

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]

env:
  NODE_VERSION: '18'

jobs:
  pr-validation:
    name: PR Metadata Validation
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Check PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
        continue-on-error: true
      
      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const changes = additions + deletions;
            
            console.log(`PR has ${changes} changes (${additions} additions, ${deletions} deletions)`);
            
            if (changes > 1000) {
              core.warning('⚠️ This PR is quite large. Consider breaking it into smaller PRs.');
            }
            
            if (changes > 2000) {
              core.setFailed('❌ PR is too large (>2000 changes). Please split into smaller PRs.');
            }
      
      - name: Check PR description
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            if (body.length < 50) {
              core.setFailed('❌ PR description is too short. Please provide more details.');
            }
            
            const hasChecklist = body.includes('- [ ]') || body.includes('- [x]');
            if (!hasChecklist) {
              core.warning('⚠️ PR does not include a checklist. Consider adding one.');
            }
      
      - name: Label PR based on size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const changes = pr.additions + pr.deletions;
            
            let sizeLabel = 'size/XS';
            if (changes > 10) sizeLabel = 'size/S';
            if (changes > 50) sizeLabel = 'size/M';
            if (changes > 200) sizeLabel = 'size/L';
            if (changes > 500) sizeLabel = 'size/XL';
            if (changes > 1000) sizeLabel = 'size/XXL';
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: [sizeLabel]
            });

  changed-files:
    name: Detect Changed Files
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      services: ${{ steps.filter.outputs.services }}
      database: ${{ steps.filter.outputs.database }}
      k8s: ${{ steps.filter.outputs.k8s }}
      docs: ${{ steps.filter.outputs.docs }}
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'
            services:
              - 'backend/services/**'
            database:
              - 'backend/database/**'
              - 'backend/migrations/**'
            k8s:
              - 'k8s/**'
            docs:
              - '**.md'
              - 'docs/**'

  quick-validation:
    name: Quick Validation Checks
    runs-on: ubuntu-latest
    needs: changed-files
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Check for merge conflicts
        run: |
          if git diff --check ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }}; then
            echo "✅ No merge conflicts detected"
          else
            echo "❌ Merge conflicts detected"
            exit 1
          fi
      
      - name: Check for TODO/FIXME
        run: |
          echo "Checking for TODO/FIXME comments..."
          
          TODOS=$(git diff ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} | grep -i "^+.*TODO\|^+.*FIXME" || true)
          
          if [ -n "$TODOS" ]; then
            echo "⚠️ New TODO/FIXME comments found:"
            echo "$TODOS"
          else
            echo "✅ No new TODO/FIXME comments"
          fi
        continue-on-error: true
      
      - name: Check for console.log statements
        if: needs.changed-files.outputs.frontend == 'true' || needs.changed-files.outputs.backend == 'true'
        run: |
          echo "Checking for console.log statements..."
          
          LOGS=$(git diff ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} -- '*.js' '*.jsx' '*.ts' '*.tsx' | grep -i "^+.*console\.log" || true)
          
          if [ -n "$LOGS" ]; then
            echo "⚠️ New console.log statements found (should be removed before merging):"
            echo "$LOGS"
          else
            echo "✅ No new console.log statements"
          fi
        continue-on-error: true
      
      - name: Check for hardcoded credentials
        run: |
          echo "Checking for potential hardcoded credentials..."
          
          PATTERNS="password|secret|api_key|apikey|token|credential"
          FOUND=$(git diff ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} | grep -iE "^+.*(${PATTERNS})\s*=\s*['\"][^'\"]+['\"]" || true)
          
          if [ -n "$FOUND" ]; then
            echo "⚠️ Potential hardcoded credentials found:"
            echo "$FOUND"
            echo "Please review these carefully!"
          else
            echo "✅ No obvious hardcoded credentials"
          fi
        continue-on-error: true

  backend-validation:
    name: Backend Validation
    needs: changed-files
    if: needs.changed-files.outputs.backend == 'true' || needs.changed-files.outputs.services == 'true'
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: pr_test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install and test services
        run: |
          for service in backend/services/*/; do
            if [ -f "$service/package.json" ]; then
              echo "Testing $service..."
              cd "$service"
              if [ -f "package-lock.json" ]; then
                npm ci
              else
                npm install
              fi
              npm test || echo "Tests incomplete for $service"
              cd -
            fi
          done
        env:
          NODE_ENV: test
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: postgres
          DB_PASSWORD: postgres
          JWT_SECRET: test-secret
        continue-on-error: true

  frontend-validation:
    name: Frontend Validation
    needs: changed-files
    if: needs.changed-files.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      
      - name: Run linting
        working-directory: frontend
        run: npm run lint
      
      - name: Build application
        working-directory: frontend
        run: npm run build

  database-validation:
    name: Database Migration Validation
    needs: changed-files
    if: needs.changed-files.outputs.database == 'true'
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: migration_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        working-directory: backend
        run: npm ci
      
      - name: Test migrations
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/migration_test
        run: |
          psql -h localhost -U postgres -d migration_test -f database/init.sql || true
          npm run migrate:up || echo "Migrations completed"

  k8s-validation:
    name: Kubernetes Manifests Validation
    needs: changed-files
    if: needs.changed-files.outputs.k8s == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install kubeval
        run: |
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin
      
      - name: Validate Kubernetes manifests
        run: |
          find k8s -name "*.yaml" -o -name "*.yml" | while read manifest; do
            echo "Validating $manifest..."
            kubeval "$manifest" || echo "Validation issues in $manifest"
          done
        continue-on-error: true
      
      - name: Install kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin
      
      - name: Build kustomize configurations
        run: |
          if [ -f "k8s/base/kustomization.yaml" ]; then
            kustomize build k8s/base > /dev/null && echo "✅ Base kustomization valid"
          fi
        continue-on-error: true

  performance-check:
    name: Basic Performance Check
    needs: [frontend-validation]
    if: needs.changed-files.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      
      - name: Build and analyze
        working-directory: frontend
        run: |
          npm run build
          
          echo "## Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          
          find dist -type f -name "*.js" -o -name "*.css" | while read file; do
            size=$(du -h "$file" | cut -f1)
            name=$(basename "$file")
            echo "| $name | $size |" >> $GITHUB_STEP_SUMMARY
          done

  approval-requirements:
    name: Check Approval Requirements
    runs-on: ubuntu-latest
    needs: [pr-validation, quick-validation]
    
    steps:
      - name: Check if breaking changes
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title.toLowerCase();
            const body = (pr.body || '').toLowerCase();
            
            const breakingKeywords = ['breaking', 'breaking change', 'major'];
            const hasBreaking = breakingKeywords.some(keyword => 
              title.includes(keyword) || body.includes(keyword)
            );
            
            if (hasBreaking) {
              core.warning('⚠️ This PR contains breaking changes. Additional review required.');
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['breaking-change']
              });
            }

  pr-validation-summary:
    name: PR Validation Summary
    needs:
      - pr-validation
      - quick-validation
      - backend-validation
      - frontend-validation
      - database-validation
      - k8s-validation
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate PR summary
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              'PR Metadata': '${{ needs.pr-validation.result }}',
              'Quick Checks': '${{ needs.quick-validation.result }}',
              'Backend': '${{ needs.backend-validation.result }}',
              'Frontend': '${{ needs.frontend-validation.result }}',
              'Database': '${{ needs.database-validation.result }}',
              'K8s Manifests': '${{ needs.k8s-validation.result }}'
            };
            
            let summary = '## PR Validation Results\n\n';
            summary += '| Check | Status |\n';
            summary += '|-------|--------|\n';
            
            for (const [check, status] of Object.entries(results)) {
              const emoji = status === 'success' ? '✅' : 
                           status === 'failure' ? '❌' : 
                           status === 'skipped' ? '⏭️' : '⚠️';
              summary += `| ${check} | ${emoji} ${status} |\n`;
            }
            
            await core.summary.addRaw(summary).write();
      
      - name: Check overall status
        run: |
          if [[ "${{ needs.backend-validation.result }}" == "failure" ]] || \
             [[ "${{ needs.frontend-validation.result }}" == "failure" ]] || \
             [[ "${{ needs.database-validation.result }}" == "failure" ]]; then
            echo "❌ PR validation failed"
            exit 1
          else
            echo "✅ PR validation passed"
          fi

  auto-merge-check:
    name: Auto-merge Eligibility
    needs: pr-validation-summary
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    
    steps:
      - name: Check auto-merge eligibility
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            
            // Check if PR has required labels
            const labels = pr.labels.map(l => l.name);
            const hasAutoMergeLabel = labels.includes('auto-merge');
            
            if (hasAutoMergeLabel) {
              core.info('✅ PR is eligible for auto-merge');
            } else {
              core.info('ℹ️ Add "auto-merge" label to enable auto-merge');
            }
