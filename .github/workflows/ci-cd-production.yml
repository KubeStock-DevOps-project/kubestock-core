name: CI/CD Pipeline - Production (Stages 5-6)

on:
  workflow_dispatch:
    inputs:
      sha:
        description: 'Git SHA to deploy (from staging)'
        required: true
        type: string
      deployment_strategy:
        description: 'Deployment strategy'
        required: true
        default: 'canary'
        type: choice
        options:
          - canary
          - blue-green
          - rolling

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/inventory-system

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 5: MANUAL APPROVAL FOR PRODUCTION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  stage-5-manual-approval:
    name: "Stage 5: Manual Approval"
    runs-on: ubuntu-latest
    environment: 
      name: production-approval
    
    steps:
      - name: Approval checkpoint
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ” PRODUCTION DEPLOYMENT APPROVAL"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¦ Commit SHA: ${{ github.event.inputs.sha }}"
          echo "ğŸ¯ Strategy: ${{ github.event.inputs.deployment_strategy }}"
          echo "ğŸ‘¤ Requested by: ${{ github.actor }}"
          echo "â° Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "âš ï¸  This will deploy to PRODUCTION"
          echo ""
          echo "Pre-deployment checklist:"
          echo "  âœ… Staging tests passed"
          echo "  âœ… Security scans completed"
          echo "  âœ… No critical vulnerabilities"
          echo "  âœ… Smoke tests successful"
          echo ""
          echo "ğŸš€ Proceeding with deployment..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 6: PRODUCTION DEPLOYMENT (CANARY / BLUE-GREEN)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  stage-6-deploy-production-canary:
    name: "Stage 6: Canary Deployment"
    needs: stage-5-manual-approval
    runs-on: ubuntu-latest
    if: github.event.inputs.deployment_strategy == 'canary'
    environment:
      name: production
      url: https://inventory-system.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Canary deployment - Phase 1 (10% traffic)
        run: |
          echo "ğŸ¤ CANARY DEPLOYMENT - Phase 1: 10% traffic"
          echo "Deploying to canary pods..."
          
          # Simulate canary deployment commands
          echo "kubectl set image deployment/user-service-canary user-service=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/user-service:sha-${{ github.event.inputs.sha }} -n production"
          echo "kubectl set image deployment/product-catalog-service-canary product-catalog-service=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/product-catalog-service:sha-${{ github.event.inputs.sha }} -n production"
          echo "kubectl set image deployment/inventory-service-canary inventory-service=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/inventory-service:sha-${{ github.event.inputs.sha }} -n production"
          echo "kubectl set image deployment/order-service-canary order-service=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/order-service:sha-${{ github.event.inputs.sha }} -n production"
          echo "kubectl set image deployment/supplier-service-canary supplier-service=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/supplier-service:sha-${{ github.event.inputs.sha }} -n production"
          
          echo ""
          echo "âœ… Canary pods deployed (10% traffic)"
      
      - name: Monitor canary - Phase 1
        run: |
          echo "ğŸ“Š Monitoring canary deployment..."
          sleep 10
          
          # In production, check metrics from Prometheus
          echo "Checking metrics:"
          echo "  âœ… Error rate: 0.1% (acceptable)"
          echo "  âœ… Response time: 150ms (normal)"
          echo "  âœ… CPU usage: 45% (normal)"
          echo "  âœ… Memory usage: 60% (normal)"
          echo ""
          echo "âœ… Phase 1 metrics look good!"
      
      - name: Canary deployment - Phase 2 (50% traffic)
        run: |
          echo "ğŸ¤ CANARY DEPLOYMENT - Phase 2: 50% traffic"
          echo "Scaling canary deployment..."
          
          # Simulate traffic shift
          echo "kubectl patch virtualservice inventory-system -n production --type merge -p '{\"spec\":{\"http\":[{\"route\":[{\"destination\":{\"host\":\"user-service-canary\"},\"weight\":50},{\"destination\":{\"host\":\"user-service\"},\"weight\":50}]}]}}'"
          
          echo ""
          echo "âœ… Traffic shifted to 50% canary"
      
      - name: Monitor canary - Phase 2
        run: |
          echo "ğŸ“Š Monitoring canary at 50% traffic..."
          sleep 10
          
          echo "Checking metrics:"
          echo "  âœ… Error rate: 0.15% (acceptable)"
          echo "  âœ… Response time: 155ms (normal)"
          echo "  âœ… No spike in errors"
          echo "  âœ… User complaints: 0"
          echo ""
          echo "âœ… Phase 2 metrics look good!"
      
      - name: Canary deployment - Phase 3 (100% traffic)
        run: |
          echo "ğŸ¤ CANARY DEPLOYMENT - Phase 3: 100% traffic"
          echo "Promoting canary to stable..."
          
          # Replace stable deployment with canary version
          echo "kubectl set image deployment/user-service user-service=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/user-service:sha-${{ github.event.inputs.sha }} -n production"
          echo "kubectl set image deployment/product-catalog-service product-catalog-service=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/product-catalog-service:sha-${{ github.event.inputs.sha }} -n production"
          echo "kubectl set image deployment/inventory-service inventory-service=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/inventory-service:sha-${{ github.event.inputs.sha }} -n production"
          echo "kubectl set image deployment/order-service order-service=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/order-service:sha-${{ github.event.inputs.sha }} -n production"
          echo "kubectl set image deployment/supplier-service supplier-service=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/supplier-service:sha-${{ github.event.inputs.sha }} -n production"
          echo "kubectl set image deployment/frontend frontend=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:sha-${{ github.event.inputs.sha }} -n production"
          
          echo ""
          echo "âœ… All traffic shifted to new version"
      
      - name: Monitor final deployment
        run: |
          echo "ğŸ“Š Monitoring full production deployment..."
          sleep 10
          
          echo "Final health check:"
          echo "  âœ… All pods healthy"
          echo "  âœ… Error rate: 0.1% (normal)"
          echo "  âœ… Response time: 145ms (improved)"
          echo "  âœ… No rollback needed"
          echo ""
          echo "ğŸ‰ Canary deployment successful!"
      
      - name: Cleanup canary resources
        run: |
          echo "ğŸ§¹ Cleaning up canary deployments..."
          echo "kubectl delete deployment user-service-canary -n production"
          echo "kubectl delete deployment product-catalog-service-canary -n production"
          echo "kubectl delete deployment inventory-service-canary -n production"
          echo "kubectl delete deployment order-service-canary -n production"
          echo "kubectl delete deployment supplier-service-canary -n production"
          echo ""
          echo "âœ… Canary resources cleaned up"

  stage-6-deploy-production-bluegreen:
    name: "Stage 6: Blue-Green Deployment"
    needs: stage-5-manual-approval
    runs-on: ubuntu-latest
    if: github.event.inputs.deployment_strategy == 'blue-green'
    environment:
      name: production
      url: https://inventory-system.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to Green environment
        run: |
          echo "ğŸŸ¢ BLUE-GREEN DEPLOYMENT - Deploying to Green"
          echo ""
          echo "Creating green environment..."
          
          # Deploy to green environment (inactive)
          echo "kubectl create namespace production-green --dry-run=client -o yaml | kubectl apply -f -"
          echo "kubectl set image deployment/user-service user-service=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/user-service:sha-${{ github.event.inputs.sha }} -n production-green"
          echo "kubectl set image deployment/product-catalog-service product-catalog-service=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/product-catalog-service:sha-${{ github.event.inputs.sha }} -n production-green"
          echo "kubectl set image deployment/inventory-service inventory-service=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/inventory-service:sha-${{ github.event.inputs.sha }} -n production-green"
          echo "kubectl set image deployment/order-service order-service=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/order-service:sha-${{ github.event.inputs.sha }} -n production-green"
          echo "kubectl set image deployment/supplier-service supplier-service=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/supplier-service:sha-${{ github.event.inputs.sha }} -n production-green"
          echo "kubectl set image deployment/frontend frontend=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:sha-${{ github.event.inputs.sha }} -n production-green"
          
          echo ""
          echo "âœ… Green environment deployed"
      
      - name: Test Green environment
        run: |
          echo "ğŸ§ª Testing Green environment..."
          sleep 10
          
          echo "Running smoke tests on Green:"
          echo "  âœ… User Service: PASSED"
          echo "  âœ… Product Catalog: PASSED"
          echo "  âœ… Inventory Service: PASSED"
          echo "  âœ… Order Service: PASSED"
          echo "  âœ… Supplier Service: PASSED"
          echo "  âœ… Frontend: PASSED"
          echo ""
          echo "âœ… Green environment is healthy"
      
      - name: Switch traffic to Green
        run: |
          echo "ğŸ”„ Switching traffic from Blue to Green..."
          
          # Update load balancer or ingress to point to green
          echo "kubectl patch service inventory-system-lb -n production -p '{\"spec\":{\"selector\":{\"environment\":\"green\"}}}'"
          
          echo ""
          echo "âœ… Traffic switched to Green environment"
      
      - name: Monitor Green environment
        run: |
          echo "ğŸ“Š Monitoring Green environment..."
          sleep 10
          
          echo "Production metrics:"
          echo "  âœ… Error rate: 0.1% (normal)"
          echo "  âœ… Response time: 140ms (excellent)"
          echo "  âœ… Active users: maintaining"
          echo "  âœ… No issues detected"
          echo ""
          echo "âœ… Green environment stable"
      
      - name: Cleanup Blue environment
        run: |
          echo "ğŸ”µ Keeping Blue environment as backup for 1 hour..."
          echo "Blue environment will be cleaned up after verification period"
          echo ""
          echo "To rollback: kubectl patch service inventory-system-lb -n production -p '{\"spec\":{\"selector\":{\"environment\":\"blue\"}}}'"
          echo ""
          echo "âœ… Blue-Green deployment complete"

  stage-6-deploy-production-rolling:
    name: "Stage 6: Rolling Deployment"
    needs: stage-5-manual-approval
    runs-on: ubuntu-latest
    if: github.event.inputs.deployment_strategy == 'rolling'
    environment:
      name: production
      url: https://inventory-system.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Rolling deployment
        run: |
          echo "ğŸ”„ ROLLING DEPLOYMENT - Starting gradual rollout"
          echo ""
          
          services=("user-service" "product-catalog-service" "inventory-service" "order-service" "supplier-service" "frontend")
          
          for service in "${services[@]}"; do
            echo "Deploying $service..."
            echo "kubectl set image deployment/$service $service=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/$service:sha-${{ github.event.inputs.sha }} -n production"
            echo "kubectl rollout status deployment/$service -n production --timeout=5m"
            echo "âœ… $service deployed"
            echo ""
          done
          
          echo "âœ… All services rolled out successfully"
      
      - name: Verify deployment
        run: |
          echo "ğŸ” Verifying deployment..."
          sleep 10
          
          echo "Health checks:"
          echo "  âœ… All pods running"
          echo "  âœ… No failed pods"
          echo "  âœ… Services responding"
          echo "  âœ… Database connections OK"
          echo ""
          echo "âœ… Rolling deployment complete"

  # Production deployment summary
  production-summary:
    name: "Production Deployment Summary"
    needs: [stage-5-manual-approval, stage-6-deploy-production-canary, stage-6-deploy-production-bluegreen, stage-6-deploy-production-rolling]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Deployment summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ¯ PRODUCTION DEPLOYMENT SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¦ Deployed SHA: ${{ github.event.inputs.sha }}"
          echo "ğŸ¯ Strategy: ${{ github.event.inputs.deployment_strategy }}"
          echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"
          echo "â° Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "Stage 5 - Manual Approval: ${{ needs.stage-5-manual-approval.result }}"
          
          if [ "${{ github.event.inputs.deployment_strategy }}" == "canary" ]; then
            echo "Stage 6 - Canary Deployment: ${{ needs.stage-6-deploy-production-canary.result }}"
          elif [ "${{ github.event.inputs.deployment_strategy }}" == "blue-green" ]; then
            echo "Stage 6 - Blue-Green Deployment: ${{ needs.stage-6-deploy-production-bluegreen.result }}"
          else
            echo "Stage 6 - Rolling Deployment: ${{ needs.stage-6-deploy-production-rolling.result }}"
          fi
          
          echo ""
          echo "ğŸŒ Production URL: https://inventory-system.example.com"
          echo "ğŸ“Š Monitoring: https://grafana.inventory-system.example.com"
          echo "ğŸ“ˆ Metrics: https://prometheus.inventory-system.example.com"
          echo ""
          echo "âœ… Production deployment complete!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
