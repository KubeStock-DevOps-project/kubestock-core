name: Backend Services CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/services/**'
      - '.github/workflows/backend-services-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'backend/services/**'
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  service-matrix:
    name: Build and Test Services
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - name: user-service
            port: 3001
          - name: product-catalog-service
            port: 3002
          - name: inventory-service
            port: 3003
          - name: order-service
            port: 3004
          - name: supplier-service
            port: 3005
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: ${{ matrix.service.name }}_test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        working-directory: backend/services/${{ matrix.service.name }}
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi
      
      - name: Create test environment file
        working-directory: backend/services/${{ matrix.service.name }}
        run: |
          cat > .env.test << EOF
          NODE_ENV=test
          PORT=${{ matrix.service.port }}
          DB_HOST=localhost
          DB_PORT=5432
          DB_NAME=${{ matrix.service.name }}_test_db
          DB_USER=postgres
          DB_PASSWORD=postgres
          JWT_SECRET=test-jwt-secret-key-for-ci
          JWT_EXPIRES_IN=24h
          EOF
      
      - name: Run linting
        working-directory: backend/services/${{ matrix.service.name }}
        run: npm run lint || echo "No linting script configured"
        continue-on-error: true
      
      - name: Run unit tests
        working-directory: backend/services/${{ matrix.service.name }}
        env:
          NODE_ENV: test
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_NAME: ${{ matrix.service.name }}_test_db
          JWT_SECRET: test-jwt-secret-key-for-ci
        run: npm test || echo "No tests configured for ${{ matrix.service.name }}"
        continue-on-error: true
      
      - name: Build Docker image
        working-directory: backend/services/${{ matrix.service.name }}
        run: |
          docker build -t ${{ matrix.service.name }}:test .
      
      - name: Test Docker image
        working-directory: backend/services/${{ matrix.service.name }}
        run: |
          docker run -d --name ${{ matrix.service.name }}-test \
            -e NODE_ENV=test \
            -e PORT=${{ matrix.service.port }} \
            -e DB_HOST=host.docker.internal \
            -e DB_PORT=5432 \
            -e DB_USER=postgres \
            -e DB_PASSWORD=postgres \
            -e JWT_SECRET=test-jwt-secret \
            --add-host=host.docker.internal:host-gateway \
            -p ${{ matrix.service.port }}:${{ matrix.service.port }} \
            ${{ matrix.service.name }}:test
          
          sleep 10
          
          # Check if container is running
          docker ps | grep ${{ matrix.service.name }}-test
          
          # Check health endpoint
          curl -f http://localhost:${{ matrix.service.port }}/health || echo "Health check endpoint not available"
          
          # Cleanup
          docker stop ${{ matrix.service.name }}-test
          docker rm ${{ matrix.service.name }}-test
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.service.name }}
          path: |
            backend/services/${{ matrix.service.name }}/coverage/
            backend/services/${{ matrix.service.name }}/test-results/
          retention-days: 7
          if-no-files-found: ignore

  service-dependencies-check:
    name: Check Service Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Check for security vulnerabilities
        run: |
          for service in user-service product-catalog-service inventory-service order-service supplier-service; do
            echo "Checking $service for vulnerabilities..."
            cd backend/services/$service
            npm audit --audit-level=moderate || echo "Vulnerabilities found in $service"
            cd ../../..
          done
      
      - name: Check for outdated packages
        run: |
          for service in user-service product-catalog-service inventory-service order-service supplier-service; do
            echo "Checking outdated packages in $service..."
            cd backend/services/$service
            npm outdated || true
            cd ../../..
          done

  service-lint-aggregate:
    name: Aggregate Linting Results
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install ESLint globally
        run: npm install -g eslint
      
      - name: Run ESLint on all services
        working-directory: backend/services
        run: |
          for service in */; do
            echo "Linting $service..."
            cd "$service"
            if [ -f "package.json" ]; then
              npm ci
              npm run lint || echo "Linting issues in $service"
            fi
            cd ..
          done
        continue-on-error: true

  api-contract-tests:
    name: API Contract Tests
    needs: service-matrix
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Start all services
        working-directory: backend
        run: |
          docker-compose up -d
          sleep 45
      
      - name: Wait for services to be ready
        run: |
          services=("3001" "3002" "3003" "3004" "3005")
          for port in "${services[@]}"; do
            timeout 60 bash -c "until curl -f http://localhost:$port/health 2>/dev/null; do sleep 2; done" || echo "Service on port $port not ready"
          done
      
      - name: Run API contract tests
        run: |
          # Basic smoke tests for each service
          echo "Testing User Service..."
          curl -X GET http://localhost:3001/health || echo "User service health check failed"
          
          echo "Testing Product Catalog Service..."
          curl -X GET http://localhost:3002/health || echo "Product catalog service health check failed"
          
          echo "Testing Inventory Service..."
          curl -X GET http://localhost:3003/health || echo "Inventory service health check failed"
          
          echo "Testing Order Service..."
          curl -X GET http://localhost:3004/health || echo "Order service health check failed"
          
          echo "Testing Supplier Service..."
          curl -X GET http://localhost:3005/health || echo "Supplier service health check failed"
      
      - name: Cleanup
        if: always()
        working-directory: backend
        run: docker-compose down -v

  service-ci-status:
    name: Backend Services CI Status
    needs: [service-matrix, service-dependencies-check, api-contract-tests]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Check status
        run: |
          echo "Service Matrix: ${{ needs.service-matrix.result }}"
          echo "Dependencies Check: ${{ needs.service-dependencies-check.result }}"
          echo "API Contract Tests: ${{ needs.api-contract-tests.result }}"
          
          if [[ "${{ needs.service-matrix.result }}" == "failure" ]] || \
             [[ "${{ needs.service-dependencies-check.result }}" == "failure" ]] || \
             [[ "${{ needs.api-contract-tests.result }}" == "failure" ]]; then
            echo "❌ Backend Services CI failed"
            exit 1
          else
            echo "✅ Backend Services CI passed"
          fi
